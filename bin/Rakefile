# coding: utf-8

$LOAD_PATH.unshift "../lib"

exes = FileList['*.rb'].pathmap("%X.exe")

task :default => exes #["qplr-sf.exe"]

rule 'exe' => '.exy' do |t|
  sh "exerb #{t.source}"
end

rule '.exy' => ['.rb', '.ver'] do |t|
  rb,ver = *t.sources
  puts rb
  puts ver
  sh "ruby -r exerb/mkexy #{rb}"
  exy = t.name
  tmp = exy + ".tmp"
  File.rename(exy, tmp)
  open(exy, "wb") do |out|
    open(tmp,"rb")do |f|
      while line = f.gets
        if line =~ /^file:/
          out.print open(ver,"rb").read
          out.puts
        end
        out.puts line
      end
    end
  end
  File.unlink(tmp)
end


file '.ver' do |t|
  open(t.name,"w")do |out|
    out.puts <<-NNN
resource:
  version:
    file_version_number   : 0.1.0.0
    product_version_number: 0.1.0.0
    comments              : 
    company_name          : Nikken Sekkei Civil Eng. Ltd.
    legal_copyright       : Atsushi Tanabe
    legal_trademarks      : 
    file_version          : Version 0.1
    product_version       : Version 0.1
    product_name          : 
    file_description      : 
    internal_name         : #{t.name.pathmap '%X'}
    original_filename     : #{t.name.pathmap '%X.rb'}
    private_build         : 
    special_build         : 
    NNN
  end
  raise "#{t.name}の修正が必要です．"
end


